# 模組 06：訊號處理基礎

> 理解數位訊號處理的基本概念

**對應專案檔案**:
- [`examples/arm_fir_example_f32.c`](../examples/arm_fir_example_f32.c)
- [`CMSIS/DSP_Lib/Source/FilteringFunctions/`](../CMSIS/DSP_Lib/Source/FilteringFunctions/)

## 📌 學習目標

- ✅ 理解類比訊號與數位訊號
- ✅ 認識取樣定理（Nyquist）
- ✅ 了解時域與頻域
- ✅ 學習濾波器基本原理
- ✅ 區分 FIR 與 IIR 濾波器

---

## 開始之前：為什麼嵌入式系統需要訊號處理？

想像一下，你正在開發一個**智慧手環**：
- 📊 **心率感測器**：測量心跳，但充滿雜訊
- 🎤 **麥克風**：接收語音指令，但有背景噪音
- 📱 **加速度計**：偵測運動，但有震動干擾

**所有這些感測器都會產生「訊號」，而訊號都有「雜訊」**。

**訊號處理的核心任務**：
1. 🎯 **保留想要的訊號**（例如：心跳、語音）
2. 🗑️ **去除不要的雜訊**（例如：高頻干擾、電源雜訊）
3. 📉 **分析訊號特徵**（例如：心率、語音辨識）

**為什麼在 Cortex-M3 上學訊號處理？**

嵌入式系統的限制：
- ⚡ **即時性**：必須在微秒內處理訊號（不能等太久）
- 💾 **記憶體少**：只有 64 KB RAM（不能儲存太多資料）
- 🔋 **低功耗**：靠電池供電（不能一直全速運算）
- 💰 **成本低**：沒有 GPU、沒有浮點運算器（M3 沒有 FPU）

**解決方案**：**高效率的數位濾波器** (Digital Filters)
- 使用 **FIR/IIR 濾波器**去除雜訊
- 使用 **CMSIS-DSP 函式庫**加速運算
- 使用 **定點運算**節省功耗

**本模組將回答的問題**：
- ❓ 為什麼類比訊號要轉成數位訊號？
- ❓ 取樣頻率（Sampling Rate）要設多高？太低會怎樣？
- ❓ 時域和頻域有什麼差別？為什麼要看頻域？
- ❓ 濾波器如何去除雜訊？
- ❓ FIR 和 IIR 哪個比較好？

讓我們從最基礎的「訊號」開始！

---

## 1. 類比訊號 vs 數位訊號

### 1.1 什麼是「訊號」？

**訊號** (Signal) = **隨時間變化的物理量**

生活中到處都是訊號：

| 物理現象 | 訊號類型 | 隨時間變化的量 |
|---------|---------|---------------|
| 🎤 說話 | 聲波 | 空氣壓力 |
| 🌡️ 溫度 | 熱訊號 | 溫度值 |
| 💓 心跳 | 生理訊號 | 血壓 |
| 📻 廣播 | 電磁波 | 電場強度 |
| 🔦 光線 | 光訊號 | 光強度 |

**嵌入式系統如何感測這些訊號？**

透過**感測器** (Sensor) 將物理量轉換成**電壓訊號**：

```
┌────────────────────────────────────────────────┐
│         感測器將物理量轉換成電壓                │
├────────────────────────────────────────────────┤
│                                                  │
│  麥克風 (聲音 → 電壓)                           │
│  ┌──────────────────────────────────────┐      │
│  │ 聲波震動 → 薄膜震動 → 線圈切割磁場   │      │
│  │          → 產生電壓 (0.1 ~ 100 mV)   │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  溫度感測器 (溫度 → 電壓)                       │
│  ┌──────────────────────────────────────┐      │
│  │ 溫度 → 熱敏電阻阻值變化 → 電壓變化   │      │
│  │      (例如: 25°C → 2.5V, 26°C → 2.6V)│      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  加速度計 (加速度 → 電壓)                       │
│  ┌──────────────────────────────────────┐      │
│  │ 加速度 → 微小質量塊位移 → 電容變化   │      │
│  │        → 電壓變化                    │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

這些電壓訊號都是**類比訊號**。

---

### 1.2 類比訊號的特性

**類比訊號** (Analog Signal) = **連續的電壓波形**

```
┌────────────────────────────────────────────────┐
│         類比訊號 (Analog Signal)                │
├────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │      連續的電壓波形                   │      │
│  │  電壓                                 │      │
│  │   ↑    ╱╲      ╱╲      ╱╲            │      │
│  │ 3V│   ╱  ╲    ╱  ╲    ╱  ╲           │      │
│  │ 2V│  ╱    ╲  ╱    ╲  ╱    ╲          │      │
│  │ 1V│ ╱      ╲╱      ╲╱      ╲         │      │
│  │ 0V├────────────────────────────→ 時間 │      │
│  │   0ms  5ms  10ms 15ms 20ms           │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  特性:                                          │
│  • 連續值: 任何時刻都有電壓值                   │
│  • 無限精度: 1.5V, 1.51V, 1.511V...            │
│  • 直接對應物理量                               │
│                                                  │
│  優點:                                          │
│  ✓ 自然、直觀                                   │
│  ✓ 不需轉換，感測器直接輸出                     │
│                                                  │
│  缺點:                                          │
│  ✗ 易受雜訊影響 (一點干擾就失真)                │
│  ✗ 難以儲存 (需要錄音帶、黑膠唱片)              │
│  ✗ 難以處理 (需要類比電路，很複雜)              │
│  ✗ 長距離傳輸會衰減                             │
│                                                  │
└────────────────────────────────────────────────┘
```

**生活類比**：類比訊號就像**水彩畫**
- 顏色是連續的（無限多種紅色）
- 但一碰到水就會暈開（易受干擾）
- 複製很困難（每次都會失真）

---

### 1.3 數位訊號的特性

**數位訊號** (Digital Signal) = **離散的數字序列**

```
┌────────────────────────────────────────────────┐
│         數位訊號 (Digital Signal)               │
├────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │      離散的樣本點                     │      │
│  │  數值                                 │      │
│  │   ↑    ●              ●               │      │
│  │ 3 │   ╱ ╲            ╱ ╲             │      │
│  │ 2 │  ●   ●          ●   ●            │      │
│  │ 1 │ ╱     ╲        ╱     ╲           │      │
│  │ 0 ├●───────●──────●───────●─→ 時間   │      │
│  │   0ms  5ms  10ms 15ms 20ms           │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  資料: [0, 3, 2, 0, 0, 3, 2, 0, ...]            │
│                                                  │
│  特性:                                          │
│  • 離散樣本: 只在特定時間點有值                 │
│  • 有限精度: 受限於位元數 (8-bit, 16-bit)      │
│  • 用數字表示                                   │
│                                                  │
│  優點:                                          │
│  ✓ 抗雜訊能力強 (0 就是 0, 3 就是 3)            │
│  ✓ 易於儲存 (存成檔案: MP3, WAV)               │
│  ✓ 易於處理 (用程式運算)                        │
│  ✓ 完美複製 (數字不會失真)                      │
│  ✓ 可加密、壓縮、錯誤更正                       │
│                                                  │
│  缺點:                                          │
│  ✗ 需要 ADC 轉換                                │
│  ✗ 有量化誤差                                   │
│  ✗ 需要足夠的取樣頻率                           │
│                                                  │
└────────────────────────────────────────────────┘
```

**生活類比**：數位訊號就像**樂高積木**
- 只有固定的形狀（有限精度）
- 但非常穩定（不易損壞）
- 複製完美（每塊積木都一樣）

---

### 1.4 為什麼嵌入式系統使用數位訊號？

**關鍵原因**：**微控制器只能處理數位訊號**

Cortex-M3 是**數位處理器**：
- 只能做加減乘除運算
- 不能直接處理連續的電壓
- 需要先把類比訊號**數位化**

**實際範例：心率監測**

```
┌────────────────────────────────────────────────┐
│       心率監測的訊號處理流程                    │
├────────────────────────────────────────────────┤
│                                                  │
│  【步驟 1】感測器產生類比訊號                   │
│  ┌──────────────────────────────────────┐      │
│  │ 心跳 → 光學感測器 → 類比電壓         │      │
│  │                                      │      │
│  │  ╱╲    ╱╲    ╱╲   ← 類比波形        │      │
│  │ ╱  ╲  ╱  ╲  ╱  ╲                    │      │
│  │╱    ╲╱    ╲╱    ╲                   │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【步驟 2】ADC 轉換成數位訊號                   │
│  ┌──────────────────────────────────────┐      │
│  │ ADC 每 10ms 取樣一次                 │      │
│  │ 結果: [50, 80, 120, 100, 60, ...]   │      │
│  │                                      │      │
│  │  ●    ●    ●   ← 數位樣本            │      │
│  │ ╱ ╲  ╱ ╲  ╱ ╲                       │      │
│  │●   ●●   ●●   ●                      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【步驟 3】數位濾波器去除雜訊                   │
│  ┌──────────────────────────────────────┐      │
│  │ FIR 濾波器處理                       │      │
│  │ 結果: [52, 78, 118, 98, 62, ...]    │      │
│  │ (去除高頻雜訊，波形更平滑)            │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【步驟 4】計算心率                             │
│  ┌──────────────────────────────────────┐      │
│  │ 偵測波峰間距 → 計算頻率              │      │
│  │ 心率 = 75 BPM                        │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

**為什麼不直接用類比電路濾波？**

| 方案 | 優點 | 缺點 |
|------|------|------|
| **類比濾波器** (RC 電路) | 不需 ADC、即時 | 難調整、會老化、佔空間、成本高 |
| **數位濾波器** (本專案) | 彈性高、精確、穩定 | 需 ADC、有延遲 |

**數位濾波器的優勢**：
1. ✅ **彈性**：改程式碼就能改濾波器（不用換電路）
2. ✅ **精確**：可設計非常複雜的濾波器
3. ✅ **穩定**：不受溫度、老化影響
4. ✅ **成本**：一顆 MCU 可做多種濾波器

---

## 2. ADC 與 DAC

### 2.1 ADC：類比轉數位

**ADC** = **Analog-to-Digital Converter**（類比數位轉換器）

**工作原理**：
1. **取樣** (Sampling)：在特定時間點測量電壓
2. **量化** (Quantization)：將連續電壓轉成離散數字

```
┌────────────────────────────────────────────────┐
│         ADC 的兩個步驟                          │
├────────────────────────────────────────────────┤
│                                                  │
│  【步驟 1】取樣 (Sampling)                      │
│  ━━━━━━━━━━━━━━━━━━━━                         │
│  決定「何時」測量電壓                           │
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │  連續波形                             │      │
│  │    ╱╲    ╱╲    ╱╲                    │      │
│  │   ╱  ╲  ╱  ╲  ╱  ╲                   │      │
│  │  ╯    ╲╯    ╲╯    ╲                  │      │
│  │   ↓   ↓  ↓   ↓  ↓   ↓  ← 取樣時間點  │      │
│  │  每隔 Ts 秒取樣一次                   │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  取樣頻率 fs = 1 / Ts                           │
│  例如: Ts = 20.83 μs → fs = 48 kHz             │
│                                                  │
│  【步驟 2】量化 (Quantization)                  │
│  ━━━━━━━━━━━━━━━━━━━━━                        │
│  決定「如何」將電壓轉成數字                     │
│                                                  │
│  假設使用 3-bit ADC (可表示 0-7):              │
│  ┌──────────────────────────────────────┐      │
│  │  電壓範圍: 0V ~ 3.3V                 │      │
│  │  分成 8 階 (2^3 = 8)                 │      │
│  │                                      │      │
│  │  7  ┤  2.89V ~ 3.30V → 7            │      │
│  │  6  ┤  2.48V ~ 2.89V → 6            │      │
│  │  5  ┤  2.06V ~ 2.48V → 5            │      │
│  │  4  ┤  1.65V ~ 2.06V → 4            │      │
│  │  3  ┤  1.24V ~ 1.65V → 3            │      │
│  │  2  ┤  0.83V ~ 1.24V → 2            │      │
│  │  1  ┤  0.41V ~ 0.83V → 1            │      │
│  │  0  ┤  0.00V ~ 0.41V → 0            │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  量化步階 = 3.3V / 8 = 0.4125V                 │
│                                                  │
│  範例:                                          │
│  測量到 1.5V → 落在第 3 階 → 輸出 3            │
│  測量到 2.7V → 落在第 6 階 → 輸出 6            │
│                                                  │
└────────────────────────────────────────────────┘
```

**完整範例：麥克風訊號轉換**

```
┌────────────────────────────────────────────────┐
│  麥克風說「Hello」的 ADC 轉換過程               │
├────────────────────────────────────────────────┤
│                                                  │
│  原始類比訊號 (電壓 vs 時間)                    │
│  ┌──────────────────────────────────────┐      │
│  │ 電壓                                 │      │
│  │  3V ┤     ╱╲          ╱╲             │      │
│  │  2V ┤    ╱  ╲        ╱  ╲            │      │
│  │  1V ┤   ╱    ╲      ╱    ╲           │      │
│  │  0V ┼──╯──────╰────╯──────╰─────     │      │
│  │     0    10   20   30   40  ms       │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  取樣: fs = 48 kHz (每 20.83 μs 一次)          │
│  ┌──────────────────────────────────────┐      │
│  │ 時間 (ms) │ 電壓 (V) │ ADC 輸出      │      │
│  ├───────────┼──────────┼─────────────┤      │
│  │    0      │   0.2    │    49        │      │
│  │    5      │   1.8    │   447        │      │
│  │   10      │   2.9    │   720        │      │
│  │   15      │   1.5    │   372        │      │
│  │   20      │   0.3    │    74        │      │
│  │   25      │   1.2    │   298        │      │
│  │   30      │   2.7    │   670        │      │
│  │  ...      │  ...     │   ...        │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  假設使用 10-bit ADC:                           │
│  • 解析度 = 3.3V / 1024 = 3.22 mV/step         │
│  • 1.8V → 1.8 / 0.00322 = 558.8 → 559         │
│                                                  │
│  數位訊號 (儲存在陣列)                          │
│  int16_t samples[] = {49, 447, 720, 372, ...}; │
│                                                  │
└────────────────────────────────────────────────┘
```

**ADC 的關鍵參數**：

| 參數 | 說明 | 影響 | 範例 |
|------|------|------|------|
| **解析度** (Resolution) | 幾個 bit | 精度 | 10-bit = 1024 階, 12-bit = 4096 階 |
| **取樣率** (Sample Rate) | 每秒取樣幾次 | 能捕捉的頻率 | 48 kHz = 每秒 48000 次 |
| **轉換時間** | 一次轉換要多久 | 即時性 | LM3S6965: ~1 μs |
| **參考電壓** (Vref) | 最大測量電壓 | 量測範圍 | 3.3V (常見) |

**LM3S6965 的 ADC 規格**：
- **解析度**：10-bit (0-1023)
- **取樣率**：最高 1 MSPS (每秒 100 萬次)
- **通道數**：4 個 (可接 4 個感測器)
- **參考電壓**：3.3V

---

### 2.2 量化誤差

**問題**：ADC 無法完美還原類比訊號

**原因**：量化步階有限

```
┌────────────────────────────────────────────────┐
│         量化誤差示意圖                          │
├────────────────────────────────────────────────┤
│                                                  │
│  3-bit ADC (8 階)                               │
│  ┌──────────────────────────────────────┐      │
│  │ 階數  電壓範圍    實際電壓  量化結果  │      │
│  ├──────────────────────────────────────┤      │
│  │  7    2.89~3.30     3.1V  →   7      │      │
│  │  6    2.48~2.89     2.7V  →   6      │      │
│  │  5    2.06~2.48     2.2V  →   5      │      │
│  │  4    1.65~2.06  ← 1.95V  →   4      │      │
│  │  3    1.24~1.65     1.5V  →   3      │      │
│  │  2    0.83~1.24     1.0V  →   2      │      │
│  │  1    0.41~0.83     0.6V  →   1      │      │
│  │  0    0.00~0.41     0.2V  →   0      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  範例: 實際電壓 1.95V                           │
│  • 落在第 4 階 (1.65~2.06V)                    │
│  • 量化成 4                                     │
│  • 還原成電壓: 4 × 0.4125V = 1.65V             │
│  • 誤差: 1.95 - 1.65 = 0.3V                    │
│                                                  │
│  最大量化誤差 = ±0.5 × 量化步階                │
│               = ±0.5 × 0.4125V                 │
│               = ±0.206V                        │
│                                                  │
│  解決方案: 提高解析度                           │
│  • 10-bit ADC: 誤差 ±1.6 mV                    │
│  • 12-bit ADC: 誤差 ±0.4 mV                    │
│  • 16-bit ADC: 誤差 ±0.025 mV                  │
│                                                  │
└────────────────────────────────────────────────┘
```

**生活類比**：量化誤差就像**量體重**
- 體重計只能顯示到小數點一位（例如 65.3 kg）
- 你的真實體重可能是 65.27 kg
- 誤差 = 0.07 kg
- 想更精確？買更好的體重計（更高解析度的 ADC）

---

### 2.3 DAC：數位轉類比

**DAC** = **Digital-to-Analog Converter**（數位類比轉換器）

**工作原理**：將數字轉換成對應的電壓

```
┌────────────────────────────────────────────────┐
│         DAC 轉換示意圖                          │
├────────────────────────────────────────────────┤
│                                                  │
│  數位輸入 → 電壓輸出                            │
│  ┌──────────────────────────────────────┐      │
│  │ 數位值 │ 電壓 (3.3V 參考, 8-bit)     │      │
│  ├────────┼──────────────────────────┤      │
│  │   0    │ 0.00 V                   │      │
│  │  64    │ 0.83 V                   │      │
│  │ 128    │ 1.65 V                   │      │
│  │ 192    │ 2.48 V                   │      │
│  │ 255    │ 3.30 V                   │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  範例: 播放音樂                                 │
│  ┌──────────────────────────────────────┐      │
│  │ MP3 檔案: [50, 80, 120, 100, 60,...] │      │
│  │           ↓                          │      │
│  │         DAC 轉換                      │      │
│  │           ↓                          │      │
│  │  電壓波形:   ╱╲                      │      │
│  │            ╱  ╲╲                     │      │
│  │          ╱      ╲                    │      │
│  │           ↓                          │      │
│  │         喇叭震動                      │      │
│  │           ↓                          │      │
│  │        發出聲音                       │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

**實際應用**：
- 🎵 **音訊播放**：MP3 → DAC → 喇叭
- 📡 **通訊**：數位訊號 → DAC → RF 發射
- ⚡ **馬達控制**：PWM 數位訊號 → DAC → 馬達電壓

**注意**：LM3S6965 **沒有內建 DAC**
- 解決方案 1：使用外部 DAC 晶片
- 解決方案 2：使用 PWM 模擬 DAC（本專案）

---

## 3. 取樣定理（Nyquist-Shannon Theorem）

### 3.1 核心問題

**問題**：取樣頻率要多高才能「不失真」地還原原始訊號？

**錯誤想法**：「越高越好」
- ❌ 取樣 1 GHz？→ 記憶體爆炸、功耗爆炸
- ❌ 取樣 1 Hz？→ 訊號失真、無法還原

**正確答案**：**Nyquist 取樣定理**

---

### 3.2 Nyquist 取樣定理

**定理內容**：

> **取樣頻率必須 ≥ 訊號最高頻率的 2 倍**

```
┌────────────────────────────────────────────────┐
│             Nyquist 取樣定理                    │
├────────────────────────────────────────────────┤
│                                                  │
│  fs ≥ 2 × fmax                                 │
│  │      │                                       │
│  │      └─ 訊號中的最高頻率                     │
│  └──────── 取樣頻率                             │
│                                                  │
│  定義:                                          │
│  • Nyquist 頻率 = fs / 2                       │
│  • 只能正確重建 ≤ Nyquist 頻率的訊號            │
│                                                  │
└────────────────────────────────────────────────┘
```

**為什麼是 2 倍？**

**直覺解釋**：你至少要抓到「波峰」和「波谷」才能知道波的形狀。

```
┌────────────────────────────────────────────────┐
│  取樣不足 vs 正確取樣 vs 過度取樣               │
├────────────────────────────────────────────────┤
│                                                  │
│  原始訊號: 10 Hz 正弦波                         │
│  ┌──────────────────────────────────────┐      │
│  │      ╱╲      ╱╲      ╱╲              │      │
│  │     ╱  ╲    ╱  ╲    ╱  ╲             │      │
│  │  ──╯    ╰──╯    ╰──╯    ╰────       │      │
│  │  週期 = 100 ms (10 Hz)               │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【情況 1】取樣不足: fs = 15 Hz (< 2×10 Hz)    │
│  ┌──────────────────────────────────────┐      │
│  │      ●       ●       ●                │      │
│  │     ╱ ╲     ╱ ╲     ╱                │      │
│  │  ──●───●───●───●───●─────             │      │
│  │    ↑   ↑   ↑   ↑   ↑                 │      │
│  │  取樣點太少，連不成原本的波形         │      │
│  │  錯誤！看起來像 3 Hz 的波！(Aliasing) │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【情況 2】剛好夠: fs = 20 Hz (= 2×10 Hz)      │
│  ┌──────────────────────────────────────┐      │
│  │      ●   ●   ●   ●   ●                │      │
│  │     ╱ ╲ ╱ ╲ ╱ ╲ ╱ ╲ ╱ ╲              │      │
│  │  ──●───●───●───●───●───●─────         │      │
│  │    ↑   ↑   ↑   ↑   ↑   ↑             │      │
│  │  理論上可以還原，但沒有安全餘裕       │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【情況 3】足夠: fs = 48 Hz (> 2×10 Hz)        │
│  ┌──────────────────────────────────────┐      │
│  │      ● ● ● ● ● ● ● ● ● ●              │      │
│  │     ╱● ●╲● ●╱● ●╲● ●╱● ●╲            │      │
│  │  ──●───●───●───●───●───●─────         │      │
│  │  完美！可以精確重建原始波形            │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

---

### 3.3 實際範例

**範例 1：音訊 CD**

```
┌────────────────────────────────────────────────┐
│         為什麼 CD 使用 44.1 kHz？               │
├────────────────────────────────────────────────┤
│                                                  │
│  人耳聽覺範圍: 20 Hz ~ 20 kHz                   │
│                                                  │
│  根據 Nyquist 定理:                             │
│  fs ≥ 2 × 20 kHz = 40 kHz                      │
│                                                  │
│  為什麼選 44.1 kHz 而不是 40 kHz？              │
│  1. 安全餘裕 (4.1 kHz buffer)                   │
│  2. 方便濾波器設計                              │
│  3. 歷史原因 (配合早期錄影帶格式)                │
│                                                  │
│  頻譜圖:                                        │
│  ┌──────────────────────────────────────┐      │
│  │ 振幅                                 │      │
│  │  │ 人耳   ┆             ┆  超音波   │      │
│  │  │ 可聽   ┆  安全餘裕   ┆  聽不到   │      │
│  │  ├────────┼─────────────┼─────────  │      │
│  │  0      20 kHz      22.05 kHz      44.1 kHz│
│  │                       ↑                      │
│  │                 Nyquist 頻率                │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

**範例 2：本專案 FIR 範例**

查看 `examples/arm_fir_example_f32.c`：

```c
#define SAMPLE_RATE 48000   // 48 kHz 取樣率
#define SIGNAL_FREQ_1 1000  // 1 kHz 訊號
#define SIGNAL_FREQ_2 15000 // 15 kHz 訊號
```

**分析**：

```
┌────────────────────────────────────────────────┐
│  本專案的取樣頻率設計                           │
├────────────────────────────────────────────────┤
│                                                  │
│  訊號成分:                                      │
│  • 1 kHz 正弦波 (想保留)                        │
│  • 15 kHz 正弦波 (雜訊，想濾除)                 │
│                                                  │
│  取樣率: 48 kHz                                 │
│  Nyquist 頻率: 48/2 = 24 kHz                   │
│                                                  │
│  檢查:                                          │
│  • 1 kHz < 24 kHz ✓ (可正確重建)               │
│  • 15 kHz < 24 kHz ✓ (可正確重建)              │
│                                                  │
│  頻譜圖:                                        │
│  ┌──────────────────────────────────────┐      │
│  │ 振幅                                 │      │
│  │  │  ██         ██        │           │      │
│  │  │  ││         ││        │           │      │
│  │  ├──┴┴─────────┴┴────────┴──────────→│      │
│  │  0  1 kHz    15 kHz   24 kHz    48 kHz     │
│  │     ↑         ↑        ↑                    │
│  │   保留      濾除   Nyquist                  │
│  └──────────────────────────────────────┘      │
│                                                  │
│  FIR 濾波器設計:                                │
│  • 低通濾波器，截止頻率 6 kHz                   │
│  • 保留 1 kHz，濾除 15 kHz                      │
│                                                  │
└────────────────────────────────────────────────┘
```

---

### 3.4 Aliasing（混疊）

**什麼是 Aliasing？**

當取樣頻率不足時，**高頻訊號會被誤認為低頻訊號**。

```
┌────────────────────────────────────────────────┐
│         Aliasing 混疊效應                       │
├────────────────────────────────────────────────┤
│                                                  │
│  範例: 25 Hz 訊號，用 20 Hz 取樣               │
│        (違反 Nyquist: 20 < 2×25)               │
│                                                  │
│  原始訊號: 25 Hz (黑線)                         │
│  ┌──────────────────────────────────────┐      │
│  │        ╱╲  ╱╲  ╱╲  ╱╲  ╱╲           │      │
│  │       ╱  ╲╱  ╲╱  ╲╱  ╲╱  ╲          │      │
│  │  ────╯                    ╰────      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  取樣點: (紅色 ●)                               │
│  ┌──────────────────────────────────────┐      │
│  │        ╱╲  ╱╲  ╱╲  ╱╲  ╱╲           │      │
│  │       ╱●╲╱ ●╲╱ ●╲╱ ●╲╱ ●╲          │      │
│  │  ────●──────────────────●────        │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  重建訊號: 5 Hz (綠線，錯誤！)                  │
│  ┌──────────────────────────────────────┐      │
│  │    ●           ●           ●          │      │
│  │   ╱ ╲         ╱ ╲         ╱ ╲        │      │
│  │  ●───●───────●───●───────●───●       │      │
│  │                                       │      │
│  │  25 Hz 被誤認成 5 Hz！                │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  公式: 混疊頻率 = |f - n×fs|                   │
│        (n 選擇使結果 < fs/2)                    │
│                                                  │
│  計算: f = 25 Hz, fs = 20 Hz                   │
│        混疊頻率 = |25 - 1×20| = 5 Hz           │
│                                                  │
└────────────────────────────────────────────────┘
```

**生活中的 Aliasing 範例**：

**電影中的車輪倒轉**：
- 車輪實際向前轉（例如 10 圈/秒）
- 電影拍攝 24 fps（取樣不足）
- 看起來好像向後轉！

**直升機螺旋槳看起來靜止**：
- 螺旋槳轉速接近相機快門速度
- 每次快門打開時，螺旋槳都在同樣位置
- 看起來沒在轉

**如何避免 Aliasing？**

1. ✅ **提高取樣頻率** (fs ≥ 2×fmax)
2. ✅ **使用反混疊濾波器** (Anti-aliasing Filter)
   - 在 ADC 前加類比低通濾波器
   - 先濾除 > fs/2 的高頻成分
   - 確保進入 ADC 的訊號符合 Nyquist 定理

```
┌────────────────────────────────────────────────┐
│  正確的訊號鏈設計 (避免 Aliasing)               │
├────────────────────────────────────────────────┤
│                                                  │
│  感測器 → [反混疊濾波器] → ADC → 數位處理      │
│            ↑ 類比低通濾波器                     │
│            截止頻率 < fs/2                      │
│                                                  │
└────────────────────────────────────────────────┘
```

---

## 4. 時域與頻域

### 4.1 兩種觀察訊號的方式

**時域** (Time Domain) = 看訊號「隨時間如何變化」
**頻域** (Frequency Domain) = 看訊號「包含哪些頻率」

**生活類比**：

```
┌────────────────────────────────────────────────┐
│         樂團演奏的兩種觀察方式                  │
├────────────────────────────────────────────────┤
│                                                  │
│  時域觀點: 錄音波形                             │
│  ┌──────────────────────────────────────┐      │
│  │  「聽到的聲音」                       │      │
│  │   ╱╲╱╲  ╱╲   ╱╲╱╲╱╲                 │      │
│  │  ╱    ╲╱  ╲ ╱        ╲               │      │
│  │ ╯          ╰           ╰──────        │      │
│  │ 時間 →                                │      │
│  └──────────────────────────────────────┘      │
│  問題: 看不出是哪些樂器在演奏？                 │
│                                                  │
│  頻域觀點: 頻譜分析                             │
│  ┌──────────────────────────────────────┐      │
│  │  「拆解成不同頻率」                   │      │
│  │    ██     ██        ██                │      │
│  │    ││     ││        ││                │      │
│  │    ││     ││        ││                │      │
│  │  ──┴┴─────┴┴────────┴┴────── 頻率 →  │      │
│  │   低音   鋼琴      小提琴              │      │
│  │  100Hz  440Hz     880Hz                │      │
│  └──────────────────────────────────────┘      │
│  優點: 一眼看出有哪些樂器！                     │
│                                                  │
└────────────────────────────────────────────────┘
```

---

### 4.2 時域表示法

**時域** = 看訊號的**振幅隨時間變化**

```
┌────────────────────────────────────────────────┐
│         時域表示法                              │
├────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │  振幅                                 │      │
│  │   ↑     ╱╲      ╱╲      ╱╲           │      │
│  │ 1V│    ╱  ╲    ╱  ╲    ╱  ╲          │      │
│  │   │   ╱    ╲  ╱    ╲  ╱    ╲         │      │
│  │ 0V├──╯──────╲╱──────╲╯──────╲────→   │      │
│  │-1V│                              時間 │      │
│  │   0     10    20    30    40   ms    │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  數學表示: x(t) = A × sin(2πft + φ)            │
│  • A: 振幅 (Amplitude)                          │
│  • f: 頻率 (Frequency)                          │
│  • φ: 相位 (Phase)                              │
│  • t: 時間                                      │
│                                                  │
│  範例: x(t) = 1 × sin(2π×100t)                 │
│  → 1V 振幅, 100 Hz 頻率的正弦波                 │
│                                                  │
│  優點:                                          │
│  ✓ 直觀，符合我們的感知                         │
│  ✓ 容易測量 (示波器)                            │
│                                                  │
│  缺點:                                          │
│  ✗ 看不出頻率成分                               │
│  ✗ 難以分析複雜訊號                             │
│                                                  │
└────────────────────────────────────────────────┘
```

**實際範例：心電圖 (ECG)**
- 橫軸：時間（秒）
- 縱軸：電壓（mV）
- 用途：觀察心跳節律是否正常

---

### 4.3 頻域表示法

**頻域** = 看訊號**包含哪些頻率成分**

```
┌────────────────────────────────────────────────┐
│         頻域表示法                              │
├────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │  振幅                                 │      │
│  │   ↑                                   │      │
│  │ 1V│  ██                               │      │
│  │   │  ││                               │      │
│  │   │  ││                               │      │
│  │ 0V├──┴┴───────────────────────────→   │      │
│  │   0  100      200      300    頻率(Hz)│      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  意義: 訊號只包含 100 Hz 的成分                 │
│                                                  │
│  複雜訊號範例: 1 kHz + 15 kHz (本專案)         │
│  ┌──────────────────────────────────────┐      │
│  │  振幅                                 │      │
│  │   ↑                                   │      │
│  │   │  ██         ██                    │      │
│  │   │  ││         ││                    │      │
│  │   ├──┴┴─────────┴┴────────────────→   │      │
│  │   0  1kHz     15kHz         頻率      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  意義: 訊號由 1 kHz 和 15 kHz 兩個正弦波組成    │
│                                                  │
│  優點:                                          │
│  ✓ 一眼看出頻率成分                             │
│  ✓ 容易設計濾波器                               │
│  ✓ 適合訊號分析                                 │
│                                                  │
│  缺點:                                          │
│  ✗ 失去時間資訊                                 │
│  ✗ 不直觀                                       │
│                                                  │
└────────────────────────────────────────────────┘
```

**實際範例：音頻等化器**
- 橫軸：頻率（Hz）
- 縱軸：增益（dB）
- 用途：調整低音/中音/高音

---

### 4.4 傅立葉轉換 (Fourier Transform)

**問題**：如何從時域轉到頻域？

**答案**：**傅立葉轉換** (Fourier Transform, FT)

**核心概念**：

> **任何週期訊號都可以分解成一堆正弦波的總和**

這個概念稱為「**傅立葉級數**」(Fourier Series)

```
┌────────────────────────────────────────────────┐
│      傅立葉分解: 方波 = 無限個正弦波            │
├────────────────────────────────────────────────┤
│                                                  │
│  原始方波 (時域)                                │
│  ┌──────────────────────────────────────┐      │
│  │   ┌───┐     ┌───┐     ┌───┐          │      │
│  │   │   │     │   │     │   │          │      │
│  │  ─┘   └─────┘   └─────┘   └────      │      │
│  └──────────────────────────────────────┘      │
│                  ↓ 傅立葉分解                   │
│  ┌──────────────────────────────────────┐      │
│  │ 基頻 (1× f0)       ╱╲      ╱╲        │      │
│  │                   ╱  ╲    ╱  ╲       │      │
│  │                  ╯    ╰──╯    ╰───   │      │
│  │                                       │      │
│  │ 3 次諧波 (3× f0)  ╱╲╱╲╱╲╱╲╱╲         │      │
│  │                  ╯          ╰────    │      │
│  │                                       │      │
│  │ 5 次諧波 (5× f0)  ╱╲╱╲╱╲╱╲╱╲╱╲╱╲     │      │
│  │                  ╯              ──   │      │
│  │ ...                                  │      │
│  └──────────────────────────────────────┘      │
│                  ↓ 相加                         │
│  ┌──────────────────────────────────────┐      │
│  │ 方波 ≈ sin(f0) + 1/3·sin(3f0)        │      │
│  │          + 1/5·sin(5f0) + ...        │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  頻譜 (頻域)                                    │
│  ┌──────────────────────────────────────┐      │
│  │  │  ██  ██  ██  ██  ││               │      │
│  │  │  ││  ││  ││  ││  ││               │      │
│  │  ├──┴┴──┴┴──┴┴──┴┴──┴┴────→ 頻率     │      │
│  │  0  f0  3f0 5f0 7f0 9f0              │      │
│  │     ↑    ↑   ↑   ↑                   │      │
│  │   只有奇數次諧波                      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

**實務上的傅立葉轉換**：

| 類型 | 名稱 | 用途 | 本專案使用？ |
|------|------|------|-------------|
| **DFT** | Discrete Fourier Transform | 數學定義，計算慢 | ❌ |
| **FFT** | Fast Fourier Transform | DFT 的快速演算法 | ✅ (CMSIS-DSP) |
| **STFT** | Short-Time FT | 時頻分析 | ❌ |

**FFT 範例（CMSIS-DSP）**：

```c
#include "arm_math.h"

#define FFT_SIZE 1024

float32_t input[FFT_SIZE * 2];   // 實部+虛部
float32_t output[FFT_SIZE];      // 頻譜輸出

arm_cfft_instance_f32 fft_instance;

// 初始化 FFT
arm_cfft_init_f32(&fft_instance, FFT_SIZE);

// 執行 FFT
arm_cfft_f32(&fft_instance, input, 0, 1);

// 計算振幅
arm_cmplx_mag_f32(input, output, FFT_SIZE);

// output[i] 現在包含第 i 個頻率的振幅
```

**為什麼濾波器需要看頻域？**

```
┌────────────────────────────────────────────────┐
│  時域 vs 頻域：濾波器設計觀點                   │
├────────────────────────────────────────────────┤
│                                                  │
│  時域觀點: 很難看出怎麼設計濾波器               │
│  ┌──────────────────────────────────────┐      │
│  │  訊號 + 雜訊                          │      │
│  │   ╱╲╱╲╱╲╱╲╱╲╱╲╱╲                     │      │
│  │  ╯              ╰───                  │      │
│  │  ❓ 哪部分是訊號？哪部分是雜訊？       │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  頻域觀點: 一目了然！                           │
│  ┌──────────────────────────────────────┐      │
│  │  頻譜                                 │      │
│  │   ██         ████████                │      │
│  │   ││         ││││││││                │      │
│  │  ─┴┴─────────┴┴┴┴┴┴┴┴────→           │      │
│  │  1kHz      10-20kHz                  │      │
│  │   ↑           ↑                       │      │
│  │  訊號       雜訊                      │      │
│  │                                       │      │
│  │  解決方案: 低通濾波器，fc = 5 kHz     │      │
│  │  保留 < 5 kHz，濾除 > 5 kHz           │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

---

## 5. 濾波器基本原理

### 5.1 什麼是濾波器？

**濾波器** (Filter) = **允許特定頻率通過，阻擋其他頻率的系統**

**生活類比**：

| 濾波器 | 生活中的例子 | 功能 |
|--------|-------------|------|
| 低通濾波器 | 咖啡濾紙 | 咖啡液通過，咖啡渣被擋住 |
| 高通濾波器 | 篩子 | 小石頭通過，大石頭被擋住 |
| 帶通濾波器 | 收音機調頻 | 只聽 98.1 MHz，其他電台被濾除 |
| 帶阻濾波器 | 隔音耳塞 | 擋住外界噪音，保留自己的聲音 |

---

### 5.2 四種基本濾波器

```
┌────────────────────────────────────────────────┐
│            四種基本濾波器                       │
├────────────────────────────────────────────────┤
│                                                  │
│  【1】低通濾波器 (Low-Pass Filter, LPF)        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━                    │
│  保留低頻，濾除高頻                             │
│                                                  │
│  頻率響應:                                      │
│  ┌──────────────────────────────────────┐      │
│  │ 增益                                 │      │
│  │  1 │  ████████╲                      │      │
│  │    │  ████████╲╲                     │      │
│  │    │  ████████ ╲╲                    │      │
│  │  0 ├──────────────╲╲╲╲╲╲╲╲────────→  │      │
│  │    0         fc     2fc     頻率      │      │
│  │              ↑                        │      │
│  │          截止頻率                     │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  實際應用:                                      │
│  • 去除高頻雜訊                                 │
│  • 音訊平滑化                                   │
│  • 本專案 FIR 範例 (fc = 6 kHz)                 │
│                                                  │
│  ────────────────────────────────────────       │
│                                                  │
│  【2】高通濾波器 (High-Pass Filter, HPF)       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━                   │
│  濾除低頻，保留高頻                             │
│                                                  │
│  頻率響應:                                      │
│  ┌──────────────────────────────────────┐      │
│  │ 增益                                 │      │
│  │  1 │              ╱████████████      │      │
│  │    │            ╱╱████████████       │      │
│  │    │          ╱╱██████████           │      │
│  │  0 ├────────╱╱╱╱╱╱────────────────→  │      │
│  │    0      fc    2fc         頻率      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  實際應用:                                      │
│  • 去除直流偏移 (DC offset)                     │
│  • 去除低頻漂移                                 │
│  • 邊緣偵測 (影像處理)                          │
│                                                  │
│  ────────────────────────────────────────       │
│                                                  │
│  【3】帶通濾波器 (Band-Pass Filter, BPF)       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━                  │
│  只保留特定頻段                                 │
│                                                  │
│  頻率響應:                                      │
│  ┌──────────────────────────────────────┐      │
│  │ 增益                                 │      │
│  │  1 │        ╱████╲                   │      │
│  │    │      ╱╱████╲╲                  │      │
│  │    │    ╱╱  ████  ╲╲                │      │
│  │  0 ├──╱╱╱───────────╲╲╲╲───────────→│      │
│  │    0  f1   fc     f2      頻率        │      │
│  │       ↑    ↑      ↑                  │      │
│  │     下截止 中心  上截止                │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  實際應用:                                      │
│  • 收音機調頻 (只聽特定電台)                    │
│  • 心電圖訊號 (0.5-40 Hz)                       │
│  • 語音訊號 (300-3400 Hz)                       │
│                                                  │
│  ────────────────────────────────────────       │
│                                                  │
│  【4】帶阻濾波器 (Band-Stop Filter, BSF)       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━                  │
│  濾除特定頻段 (也叫 Notch Filter)               │
│                                                  │
│  頻率響應:                                      │
│  ┌──────────────────────────────────────┐      │
│  │ 增益                                 │      │
│  │  1 │  ████╲    ╱████████             │      │
│  │    │  ████╲╲ ╱╱████████              │      │
│  │    │  ████ ╲╱╱  ████                 │      │
│  │  0 ├──────────╲╱─────────────────→   │      │
│  │    0       f0 (50/60Hz)      頻率     │      │
│  │            ↑                          │      │
│  │       阻止頻率                        │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  實際應用:                                      │
│  • 去除 50/60 Hz 電源雜訊                       │
│  • 去除特定頻率的干擾                           │
│                                                  │
└────────────────────────────────────────────────┘
```

---

### 5.3 濾波器的關鍵參數

```
┌────────────────────────────────────────────────┐
│      濾波器規格參數 (以 LPF 為例)               │
├────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │ 增益 (dB)                            │      │
│  │   0 ─┬─────────────╲                 │      │
│  │      │ 通帶        │╲ 轉換帶          │      │
│  │      │ (Passband) │ ╲                │      │
│  │  -3 ─┤─────────────┼──╲ ← 截止頻率   │      │
│  │      │             │   ╲              │      │
│  │ -20 ─┤             │    ╲             │      │
│  │      │             │     ╲╲           │      │
│  │ -40 ─┤             │  阻帶╲╲╲ ← 衰減  │      │
│  │      │             │ (Stopband)       │      │
│  │ -60 ─┴─────────────┴──────────────→   │      │
│  │      0           fc  fs    頻率       │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【1】截止頻率 (Cutoff Frequency, fc)          │
│  ━━━━━━━━━━━━━━━━━━━━━━━                     │
│  定義: 增益衰減到 -3 dB 的頻率                 │
│  意義: -3 dB = 0.707 倍振幅 = 一半功率         │
│                                                  │
│  【2】通帶波紋 (Passband Ripple)               │
│  ━━━━━━━━━━━━━━━━━━━━━━                       │
│  定義: 通帶內的增益變化                         │
│  理想: 0 dB (完全平坦)                         │
│  實際: ±0.1 dB ~ ±1 dB                         │
│                                                  │
│  【3】阻帶衰減 (Stopband Attenuation)          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━                   │
│  定義: 阻帶的衰減程度                           │
│  範例: -40 dB = 1/100 倍振幅                   │
│        -60 dB = 1/1000 倍振幅                  │
│                                                  │
│  【4】轉換帶 (Transition Band)                 │
│  ━━━━━━━━━━━━━━━━━━━━━━                       │
│  定義: 從通帶到阻帶的過渡區域                   │
│  寬度: fs - fc                                 │
│  影響: 越窄 → 濾波器越理想 → 係數越多           │
│                                                  │
│  【5】濾波器階數 (Filter Order, N)             │
│  ━━━━━━━━━━━━━━━━━━━━━━━                     │
│  定義: FIR 濾波器的係數個數                     │
│  影響: N 越大 → 越陡峭 → 計算量越大             │
│         衰減斜率 ≈ 20N dB/decade               │
│                                                  │
└────────────────────────────────────────────────┘
```

---

## 6. FIR vs IIR 濾波器

### 6.1 基本概念

**FIR** = **Finite Impulse Response** (有限脈衝響應)
**IIR** = **Infinite Impulse Response** (無限脈衝響應)

**差異的核心**：**有沒有回授** (Feedback)

```
┌────────────────────────────────────────────────┐
│         FIR vs IIR 系統結構                     │
├────────────────────────────────────────────────┤
│                                                  │
│  【FIR 濾波器】                                 │
│  ━━━━━━━━━━━━━━                               │
│  只使用輸入樣本 (無回授)                        │
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │  x[n] ──┬─→ z⁻¹ ──┬─→ z⁻¹ ──┬─→ z⁻¹ │      │
│  │         │         │         │        │      │
│  │         ↓ ×b₀    ↓ ×b₁    ↓ ×b₂    │      │
│  │         │         │         │        │      │
│  │         └────( + )────( + )─→ y[n]  │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  方程式: y[n] = b₀x[n] + b₁x[n-1] + b₂x[n-2]   │
│                                                  │
│  特性:                                          │
│  • 只向前計算 (Feedforward)                     │
│  • 輸入消失後，輸出會在有限時間內歸零           │
│                                                  │
│  ────────────────────────────────────────       │
│                                                  │
│  【IIR 濾波器】                                 │
│  ━━━━━━━━━━━━━━                               │
│  使用輸入 + 過去輸出樣本 (有回授)               │
│                                                  │
│  ┌──────────────────────────────────────┐      │
│  │  x[n] ───→ ×b₀ ──→ ( + ) ─→ y[n]    │      │
│  │                       ↑     │        │      │
│  │                       │     └─┐      │      │
│  │                       │       ↓      │      │
│  │                       │     z⁻¹      │      │
│  │                       │       ↓      │      │
│  │                       └───×a₁─┘      │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  方程式: y[n] = b₀x[n] + a₁y[n-1]              │
│                                                  │
│  特性:                                          │
│  • 有回授 (Feedback)                            │
│  • 輸出會「記住」過去的狀態                     │
│  • 輸入消失後，輸出可能永遠不歸零               │
│                                                  │
└────────────────────────────────────────────────┘
```

---

### 6.2 脈衝響應差異

**什麼是脈衝響應？**

輸入一個「脈衝」(在 n=0 時為 1，其他時間為 0)，觀察輸出如何變化。

```
┌────────────────────────────────────────────────┐
│         脈衝響應比較                            │
├────────────────────────────────────────────────┤
│                                                  │
│  輸入脈衝: x[n] = δ[n]                          │
│  ┌──────────────────────────────────────┐      │
│  │  1 │ ●                                │      │
│  │    │                                  │      │
│  │  0 ├─●───●───●───●───●───●───●─→ n   │      │
│  │    0  1   2   3   4   5   6          │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【FIR 脈衝響應】(4 階 FIR)                     │
│  ┌──────────────────────────────────────┐      │
│  │     ●                                 │      │
│  │    ╱ ╲                                │      │
│  │   ●   ●                               │      │
│  │  ╱     ╲                              │      │
│  │ ●       ●                             │      │
│  ├─●───────●───●───●───●───●───●─→ n    │      │
│  │ 0   1   2   3   4   5   6            │      │
│  │         ↑                             │      │
│  │    在 n=4 後歸零 (有限！)             │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  【IIR 脈衝響應】(1 階 IIR, a=0.8)              │
│  ┌──────────────────────────────────────┐      │
│  │ ●                                     │      │
│  │ │╲                                    │      │
│  │ │ ╲ ●                                 │      │
│  │ │  ╲│╲ ●                              │      │
│  │ │   ╲│╲│╲ ●                           │      │
│  ├─●────╲│╲│╲│╲●─●─●─●─→ n              │      │
│  │ 0      ╲│╲│╲│...  (永遠不歸零)        │      │
│  │         ↓                             │      │
│  │    理論上無限長 (但會越來越小)         │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

---

### 6.3 詳細比較

```
┌────────────────────────────────────────────────┐
│      FIR vs IIR 詳細比較                        │
├────────────────────────────────────────────────┤
│                                                  │
│  ╔══════════════════╦═══════════╦══════════╗   │
│  ║ 特性              ║ FIR      ║ IIR      ║   │
│  ╠══════════════════╬═══════════╬══════════╣   │
│  ║ 穩定性            ║ 絕對穩定  ║ 可能不穩定║   │
│  ║ 線性相位          ║ 可實現    ║ 不可能   ║   │
│  ║ 計算複雜度        ║ 高        ║ 低       ║   │
│  ║ 係數個數          ║ 多 (50+) ║ 少 (5~10)║   │
│  ║ 記憶體需求        ║ 大        ║ 小       ║   │
│  ║ 設計難度          ║ 容易      ║ 困難     ║   │
│  ║ 陡峭度            ║ 需高階數  ║ 低階數夠 ║   │
│  ║ 本專案使用        ║ ✅        ║ ✅       ║   │
│  ╚══════════════════╩═══════════╩══════════╝   │
│                                                  │
└────────────────────────────────────────────────┘
```

**詳細說明**：

**【1】穩定性**
- **FIR**：絕對穩定（沒有回授，不會爆炸）
- **IIR**：可能不穩定（回授可能導致發散）

**【2】線性相位**
- **相位** (Phase) = 訊號的延遲
- **線性相位** = 所有頻率的延遲相同
- **為什麼重要？** 訊號不會失真

```
┌────────────────────────────────────────────────┐
│  線性相位 vs 非線性相位                         │
├────────────────────────────────────────────────┤
│                                                  │
│  原始訊號: 方波                                 │
│  ┌──────────────────────────────────────┐      │
│  │   ┌───┐   ┌───┐                      │      │
│  │   │   │   │   │                      │      │
│  │  ─┘   └───┘   └───                  │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  線性相位 FIR 濾波後: 波形相同，只是延遲        │
│  ┌──────────────────────────────────────┐      │
│  │       ┌───┐   ┌───┐                  │      │
│  │       │   │   │   │ (形狀不變)       │      │
│  │  ─────┘   └───┘   └───              │      │
│  │  ↑ 延遲                               │      │
│  └──────────────────────────────────────┘      │
│                                                  │
│  非線性相位 IIR 濾波後: 波形失真                │
│  ┌──────────────────────────────────────┐      │
│  │       ╱╲   ╱╲                        │      │
│  │      ╱  ╲ ╱  ╲ (形狀改變！)          │      │
│  │  ───╯    ╰    ╰───                  │      │
│  └──────────────────────────────────────┘      │
│                                                  │
└────────────────────────────────────────────────┘
```

**【3】計算複雜度**

假設相同效果：
- **FIR**：需要 50 個係數 → 50 次乘法 + 50 次加法
- **IIR**：只需 5 個係數 → 5 次乘法 + 5 次加法

**【4】應用選擇指南**

| 應用 | 推薦 | 原因 |
|------|------|------|
| 音訊處理 | FIR | 需要線性相位，避免失真 |
| 語音編碼 | IIR | 計算效率優先 |
| 影像處理 | FIR | 穩定性重要 |
| 控制系統 | IIR | 即時性要求高 |
| 生醫訊號 | FIR | 相位失真不可接受 |
| 通訊系統 | 兩者都用 | 看具體需求 |

---

### 6.4 本專案的選擇

查看專案檔案：

**FIR 範例**: `examples/arm_fir_example_f32.c`
```c
#define NUM_TAPS 29  // FIR 係數個數

// FIR 濾波器係數 (低通, fc=6kHz, fs=48kHz)
float32_t firCoeffs32[NUM_TAPS] = { ... };
```

**IIR 範例**: （本專案主要使用 FIR，IIR 在 CMSIS-DSP 中也有支援）

**為什麼本專案選擇 FIR？**
1. ✅ **教學友善**：FIR 概念簡單，容易理解
2. ✅ **絕對穩定**：初學者不用擔心穩定性問題
3. ✅ **線性相位**：訊號不失真
4. ✅ **CMSIS-DSP 支援**：有現成的高效實作

---

## 📝 實作練習

### 練習 1：理解取樣頻率

**問題**：
1. 如果訊號最高頻率是 10 kHz，最低取樣頻率應該是多少？
2. 為什麼 CD 音質使用 44.1 kHz 取樣率？
3. 如果用 30 kHz 取樣 25 kHz 的訊號會發生什麼事？

<details>
<summary>解答</summary>

1. **最低取樣頻率**：
   - 根據 Nyquist 定理：fs ≥ 2 × fmax
   - fs ≥ 2 × 10 kHz = **20 kHz**

2. **CD 音質 44.1 kHz**：
   - 人耳聽覺範圍：20 Hz ~ 20 kHz
   - 理論最低取樣率：2 × 20 kHz = 40 kHz
   - 44.1 kHz 提供了 **4.1 kHz 的安全餘裕**
   - 好處：
     - 有餘裕設計反混疊濾波器
     - 避免邊界頻率失真
     - 歷史原因（配合 NTSC 視訊格式）

3. **30 kHz 取樣 25 kHz 訊號**：
   - fs = 30 kHz, f = 25 kHz
   - **違反 Nyquist 定理**（30 < 2×25 = 50）
   - **會發生 Aliasing**
   - 混疊頻率 = |25 - 30| = **5 kHz**
   - 25 kHz 的高頻訊號會被誤認為 5 kHz 的低頻訊號！

</details>

---

### 練習 2：計算量化誤差

**問題**：
使用 8-bit ADC，參考電壓 3.3V，測量 2.5V 的電壓。

1. 量化步階是多少？
2. ADC 輸出值是多少？
3. 量化誤差是多少？

<details>
<summary>解答</summary>

1. **量化步階**：
   - 量化步階 = Vref / (2^N)
   - = 3.3V / 256
   - = **0.01289 V = 12.89 mV**

2. **ADC 輸出值**：
   - ADC 值 = round(2.5V / 0.01289V)
   - = round(193.95)
   - = **194**

3. **量化誤差**：
   - 重建電壓 = 194 × 0.01289V = 2.50066V
   - 誤差 = 2.50066 - 2.5 = **+0.66 mV**
   - 相對誤差 = 0.66 / 2500 = **0.026%**

</details>

---

### 練習 3：頻域分析

**問題**：
一個訊號的頻譜如下：
- 100 Hz: 振幅 1.0V
- 500 Hz: 振幅 0.5V
- 2000 Hz: 振幅 0.3V

使用截止頻率 fc = 1 kHz 的低通濾波器，哪些頻率會被保留？哪些會被濾除？

<details>
<summary>解答</summary>

**低通濾波器 fc = 1 kHz**：
- 保留 f < 1 kHz 的訊號
- 濾除 f > 1 kHz 的訊號

**結果**：
- ✅ **100 Hz (1.0V)**：保留（< 1 kHz）
- ✅ **500 Hz (0.5V)**：保留（< 1 kHz）
- ❌ **2000 Hz (0.3V)**：濾除（> 1 kHz）

**濾波後的頻譜**：
```
振幅
 │  ██
 │  ││  ██
 │  ││  ││
 ├──┴┴──┴┴─────────────→ 頻率
 0 100  500  1k   2k Hz
```

濾波後的訊號將只包含 100 Hz 和 500 Hz 的成分，2 kHz 的高頻雜訊被去除。

</details>

---

## 🎯 學習檢查點

完成本模組後，你應該能夠：

- [ ] **類比與數位**：
  - 說明類比訊號與數位訊號的差異
  - 解釋為什麼嵌入式系統使用數位訊號
  - 理解量化誤差的來源
- [ ] **ADC/DAC**：
  - 說明 ADC 的取樣與量化過程
  - 計算 ADC 解析度與量化步階
  - 理解 DAC 的轉換原理
- [ ] **取樣定理**：
  - 陳述 Nyquist 取樣定理
  - 計算最低取樣頻率
  - 解釋 Aliasing 的成因與後果
- [ ] **時域與頻域**：
  - 理解時域與頻域的差異
  - 說明傅立葉轉換的用途
  - 解釋為什麼濾波器設計需要頻域觀點
- [ ] **濾波器**：
  - 區分四種濾波器類型（低通、高通、帶通、帶阻）
  - 解釋截止頻率、阻帶衰減等參數
  - 比較 FIR 與 IIR 的優缺點
- [ ] **實作技能**：
  - 為給定應用選擇合適的取樣頻率
  - 選擇合適的濾波器類型
  - 理解本專案 FIR 範例的設計

## 🔗 下一步

[模組 07：FIR 濾波器](07-FIR濾波器.md) - 實際操作 FIR 濾波器範例，深入理解 CMSIS-DSP 函式庫

---

## 📚 延伸閱讀

**推薦書籍**：
- *Understanding Digital Signal Processing* by Richard G. Lyons（經典入門書）
- *Digital Signal Processing* by Proakis & Manolakis（大學教科書）

**線上資源**：
- [CMSIS-DSP 官方文件](https://arm-software.github.io/CMSIS_5/DSP/html/index.html)
- [Nyquist–Shannon Sampling Theorem (Wikipedia)](https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem)

**本專案相關檔案**：
- [`examples/arm_fir_example_f32.c`](../examples/arm_fir_example_f32.c) - FIR 濾波器實作
- [`CMSIS/Include/arm_math.h`](../CMSIS/Include/arm_math.h) - CMSIS-DSP 函式庫標頭檔
- [`CMSIS/DSP_Lib/Source/FilteringFunctions/`](../CMSIS/DSP_Lib/Source/FilteringFunctions/) - 濾波器函數原始碼

**實用工具**：
- [FIR Filter Designer Online](http://t-filter.engineerjs.com/) - 線上設計 FIR 濾波器係數
- [MATLAB Filter Designer](https://www.mathworks.com/help/signal/ref/filterdesigner-app.html) - 專業濾波器設計工具

---
**版本**: 2.0 | **日期**: 2025-11-16 | **作者**: 訊號處理教學團隊
